<!DOCTYPE html>
<html>
<style>
    body { max-width: 600px; margin: 0 auto; }
    textarea { width: 100%; height: 3rem; }
    #chatBox { height: 200px; overflow-y: auto; border: 1px solid; }
</style>
<body>
    <textarea id="myId" readonly></textarea>
    <button id="offerBtn">Create Offer</button>
    <textarea id="peerId" placeholder="Enter peer ID here"></textarea>
    <button id="connectBtn">Connect</button>
    <div id="status">Ready</div>
    <div id="chatBox"></div>
    <button id="pingBtn" disabled>Send Ping</button> 
</body>
<script>
    let peerConnection = null;

    const append = msg => {
        const chatBox = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.textContent = msg;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    };

    const createPeerConnection = () => {
        const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

        pc.onicecandidate = e => {
            if (!e.candidate) {
                document.getElementById('myId').value = JSON.stringify(pc.localDescription);
            }
        };

        pc.onconnectionstatechange = () => {
            document.getElementById('status').textContent = `Connection: ${pc.connectionState}`;
        };

        return pc;
    };

    const setupDataChannel = (pc, channel) => {
        const pingBtn = document.getElementById('pingBtn');
        
        channel.onopen = () => {
            pingBtn.disabled = false;
            append('Connected!');
        };
        
        channel.onmessage = e => append(`Peer: ${e.data}`);
        
        // Store reference on PC instead of global variable
        pc.dataChannel = channel;
        return channel;
    };

    document.getElementById('offerBtn').onclick = async () => {
        peerConnection = createPeerConnection();
        const dc = setupDataChannel(peerConnection, peerConnection.createDataChannel('chat'));
        
        await peerConnection.setLocalDescription(await peerConnection.createOffer());
        document.getElementById('status').textContent = 'Offer created! Share your ID.';
    };

    document.getElementById('connectBtn').onclick = async () => {
        const sdp = JSON.parse(document.getElementById('peerId').value);
        
        if (sdp.type === 'offer') {
            // Answering a remote offer
            peerConnection = createPeerConnection();
            peerConnection.ondatachannel = e => setupDataChannel(peerConnection, e.channel);
            
            await peerConnection.setRemoteDescription(sdp);
            await peerConnection.setLocalDescription(await peerConnection.createAnswer());
            document.getElementById('status').textContent = 'Answered offer! Share your ID back.';
        } else if (sdp.type === 'answer') {
            // Receiving answer to our offer
            await peerConnection.setRemoteDescription(sdp);
            document.getElementById('status').textContent = 'Connecting...';
        }
    };

    document.getElementById('pingBtn').onclick = () => {
        if (peerConnection?.dataChannel?.readyState === 'open') {
            peerConnection.dataChannel.send('ping');
            append('You: ping');
        }
    };
</script>
</html>
