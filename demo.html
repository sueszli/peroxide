<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P WebRTC Chat</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        .container { border: 1px solid #ccc; padding: 20px; border-radius: 5px; }
        #chatBox { height: 300px; border: 1px solid #ddd; padding: 10px; overflow-y: auto; margin-bottom: 10px; }
        input, button, textarea { padding: 8px; margin: 5px 0; }
        textarea { width: 100%; height: 60px; }
        .message { margin-bottom: 10px; padding: 8px; border-radius: 5px; }
        .received { background-color: #f1f1f1; }
        .sent { background-color: #d4edda; text-align: right; }
        .system { text-align: center; font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <h1>P2P Chat</h1>
        <p>Share your ID with the other person, then enter their ID to connect.</p>
        
        <div>
            <label for="myId">Your ID:</label>
            <textarea id="myId" readonly></textarea>
            <button id="copyBtn">Copy ID</button>
            <button id="createOfferBtn">Create Offer</button>
        </div>
        <div>
            <label for="peerId">Peer ID:</label>
            <textarea id="peerId" placeholder="Enter peer ID here"></textarea>
            <button id="connectBtn">Connect</button>
        </div>
        <div id="status">Ready to create an offer</div>
        
        <h2>Chat</h2>
        <div id="chatBox"></div>
        <div>
            <input type="text" id="messageInput" placeholder="Type your message..." disabled>
            <button id="sendBtn" disabled>Send</button>
        </div>
    </div>
    
    <script>
        const el = {
            myId: document.getElementById('myId'),
            peerId: document.getElementById('peerId'),
            status: document.getElementById('status'),
            chatBox: document.getElementById('chatBox'),
            messageInput: document.getElementById('messageInput'),
            sendBtn: document.getElementById('sendBtn')
        };
        
        let pc, dc; // peerConnection and dataChannel
        
        // Initialize WebRTC peer connection
        function init() {
            if (pc) pc.close();
            
            pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            
            pc.onicecandidate = e => !e.candidate && (el.myId.value = JSON.stringify(pc.localDescription));
            
            pc.onconnectionstatechange = () => {
                el.status.textContent = `Connection: ${pc.connectionState}`;
                el.status.style.color = pc.connectionState === 'connected' ? 'green' : 
                                        pc.connectionState === 'failed' ? 'red' : '';
            };
            
            pc.ondatachannel = e => { dc = e.channel; setupChannel(); };
        }
        
        // Set up data channel
        function setupChannel() {
            dc.onopen = () => {
                el.messageInput.disabled = el.sendBtn.disabled = false;
                addMsg('Connected to peer!', 'system');
                el.status.textContent = 'Connected!';
                el.status.style.color = 'green';
            };
            
            dc.onclose = () => {
                el.messageInput.disabled = el.sendBtn.disabled = true;
                addMsg('Connection closed.', 'system');
                el.status.textContent = 'Disconnected';
                el.status.style.color = 'red';
            };
            
            dc.onmessage = e => addMsg(e.data, 'received');
        }
        
        // Create an offer
        async function createOffer() {
            try {
                init();
                dc = pc.createDataChannel('chat');
                setupChannel();
                
                await pc.setLocalDescription(await pc.createOffer());
                el.status.textContent = 'Offer created! Share your ID with peer.';
            } catch (err) {
                el.status.textContent = `Error: ${err.message}`;
                el.status.style.color = 'red';
            }
        }
        
        // Connect to peer
        async function connect() {
            try {
                const peerSdp = el.peerId.value.trim();
                if (!peerSdp) {
                    el.status.textContent = 'Please enter a peer ID';
                    el.status.style.color = 'red';
                    return;
                }
                
                const sdp = JSON.parse(peerSdp);
                
                if (sdp.type === 'offer') {
                    init();
                    await pc.setRemoteDescription(new RTCSessionDescription(sdp));
                    await pc.setLocalDescription(await pc.createAnswer());
                    el.status.textContent = 'Answered offer! Share your ID back.';
                } else if (sdp.type === 'answer') {
                    await pc.setRemoteDescription(new RTCSessionDescription(sdp));
                    el.status.textContent = 'Connection establishing...';
                }
            } catch (err) {
                el.status.textContent = `Error: ${err.message}`;
                el.status.style.color = 'red';
            }
        }
        
        // Add a message to the chat
        function addMsg(msg, type) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            
            if (type === 'sent') div.textContent = `You: ${msg}`;
            else if (type === 'received') div.textContent = `Peer: ${msg}`;
            else div.textContent = msg;
            
            el.chatBox.appendChild(div);
            el.chatBox.scrollTop = el.chatBox.scrollHeight;
        }
        
        // Send a message
        function sendMsg() {
            const msg = el.messageInput.value.trim();
            if (!msg || !dc || dc.readyState !== 'open') return;
            
            dc.send(msg);
            addMsg(msg, 'sent');
            el.messageInput.value = '';
        }
        
        // Event listeners
        document.getElementById('copyBtn').addEventListener('click', () => {
            navigator.clipboard.writeText(el.myId.value)
                .then(() => {
                    const btn = document.getElementById('copyBtn');
                    btn.textContent = 'Copied!';
                    setTimeout(() => btn.textContent = 'Copy ID', 1500);
                });
        });
        
        document.getElementById('createOfferBtn').addEventListener('click', createOffer);
        document.getElementById('connectBtn').addEventListener('click', connect);
        document.getElementById('sendBtn').addEventListener('click', sendMsg);
        el.messageInput.addEventListener('keypress', e => e.key === 'Enter' && sendMsg());
        
        addMsg('To connect: One person creates an offer, shares the ID, then the other connects and shares their ID back.', 'system');
    </script>
</body>
</html>
