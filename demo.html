<!-- 
demo for 2 users manually exchanging keys.
more users would be impractical without a signaling server.

- A: creates offer, shares with B
- B: enters A's offer, creates answer, shares with A
- A: enters B's answer
- A & B: connected, can send messages
-->

<!DOCTYPE html>
<html>
<style>
    body { max-width: 600px; margin: 0 auto; }
    textarea { width: 100%; height: 3rem; }
    #chatBox { height: 200px; overflow-y: auto; border: 1px solid; }
</style>
<body>
    <textarea id="myId" readonly></textarea>
    <button id="offerBtn">Create Offer</button>
    <textarea id="peerId" placeholder="Enter peer ID here"></textarea>
    <button id="connectBtn">Connect</button>
    <div id="status">Ready</div>
    <div id="chatBox"></div>
    <button id="pingBtn" disabled>Send Ping</button> 
</body>
<script>
    let pc, dc;

    const append = msg => {
        const chatBox = document.getElementById('chatBox');

        const div = document.createElement('div');
        div.textContent = msg;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    };

    const setupDC = (channel) => {
        const pingBtn = document.getElementById('pingBtn');

        channel.onopen = () => {
            pingBtn.disabled = false;
            append('Connected!');
        };
        channel.onmessage = e => {
            append(`Peer: ${e.data}`);
        }
        return channel;
    }

    const getPC = () => {
        const myId = document.getElementById('myId');
        const status = document.getElementById('status');
        
        const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        pc.onicecandidate = e => { if (!e.candidate) myId.value = JSON.stringify(pc.localDescription) };
        pc.onconnectionstatechange = () => status.textContent = `Connection: ${pc.connectionState}`;
        pc.ondatachannel = e => dc = setupDC(e.channel);
        return pc;
    };

    document.getElementById('offerBtn').onclick = async () => {
        pc = getPC();
        dc = setupDC(pc.createDataChannel('chat'));
        await pc.setLocalDescription(await pc.createOffer());
        document.getElementById('status').textContent = 'Offer created! Share your ID.';
    };

    document.getElementById('connectBtn').onclick = async () => {
        const peerId = document.getElementById('peerId');
        const status = document.getElementById('status');

        const sdp = JSON.parse(peerId.value);
        if (sdp.type === 'offer') {
            pc = getPC();
            await pc.setRemoteDescription(sdp);
            await pc.setLocalDescription(await pc.createAnswer());
            status.textContent = 'Answered offer! Share your ID back.';
        } else if (sdp.type === 'answer') {
            await pc.setRemoteDescription(sdp);
            status.textContent = 'Connecting...';
        }
    };

    document.getElementById('pingBtn').onclick = () => {
        if (dc && dc.readyState === 'open') {
            dc.send('ping');
            append('You: ping');
        }
    };
</script>
</html>
